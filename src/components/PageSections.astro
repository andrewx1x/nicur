---
import Container from "./Container.astro";
import Section from "./Section.astro";
import Card from "./Card.astro";
import ButtonLink from "./ButtonLink.astro";
import Prose from "./Prose.astro";
import PublicationCard from "./PublicationCard.astro";
import { withBase } from "../utils/paths";

const { sections } = Astro.props;
---
{sections.map((section, index) => {
  if (section.type === "hero") {
    return (
      <Section class="hero">
        <Container>
          <div class="hero-card reveal">
            <h1>{section.title}</h1>
          </div>
        </Container>
      </Section>
    );
  }

  if (section.type === "cards") {
    return (
      <Section alt={index % 2 === 1}>
        <Container>
          {section.title ? <h2 class="section-title">{section.title}</h2> : null}
          <div class="card-grid">
            {section.items.map((item) => (
              <Card title={item.title} href={item.href} />
            ))}
          </div>
        </Container>
      </Section>
    );
  }

  if (section.type === "links") {
    return (
      <Section>
        <Container>
          {index === 0 ? (
            <h1 class="section-title">{section.title}</h1>
          ) : (
            <h2 class="section-title">{section.title}</h2>
          )}
          <div class="card-grid">
            {section.items.map((item) => (
              <Card title={item.label} href={item.href} />
            ))}
          </div>
        </Container>
      </Section>
    );
  }

  if (section.type === "list") {
    return (
      <Section alt={index % 2 === 1}>
        <Container>
          <h2 class="section-title">{section.title}</h2>
          {section.subtitle ? (
            <p>
              {section.subtitle.split("\n").map((line, lineIndex, lines) => (
                <>
                  {line}
                  {lineIndex < lines.length - 1 ? <br /> : null}
                </>
              ))}
            </p>
          ) : null}
          <Prose>
            <ol>
              {section.items.map((item) => (
                <li>
                  {typeof item === "string" ? (
                    item
                  ) : (
                    <a href={withBase(item.href)} class="list-link">{item.title}</a>
                  )}
                </li>
              ))}
            </ol>
          </Prose>
        </Container>
      </Section>
    );
  }

  if (section.type === "ordered") {
    return (
      <Section alt={index % 2 === 1}>
        <Container>
          <h2 class="section-title">{section.title}</h2>
          <Prose>
            <ol>
              {section.items.map((item) => (
                <li>{item}</li>
              ))}
            </ol>
          </Prose>
        </Container>
      </Section>
    );
  }

  if (section.type === "link") {
    return (
      <Section>
        <Container>
          <div class="card reveal">
            <ButtonLink href={section.href}>{section.title}</ButtonLink>
          </div>
        </Container>
      </Section>
    );
  }

  if (section.type === "text") {
    return (
      <Section alt={index % 2 === 1}>
        <Container>
          {section.title ? (
            index === 0 ? (
              <h1 class="section-title">{section.title}</h1>
            ) : (
              <h2 class="section-title">{section.title}</h2>
            )
          ) : null}
          <Prose>
            {section.paragraphs.map((paragraph) => (
              <p>{paragraph}</p>
            ))}
          </Prose>
        </Container>
      </Section>
    );
  }

  if (section.type === "publications") {
    return (
      <Section alt={index % 2 === 1}>
        <Container>
          {section.title ? <h2 class="section-title">{section.title}</h2> : null}
          <div class="publications-list">
            {section.items.map((item) => (
              <PublicationCard
                label={item.label}
                title={item.title}
                authors={item.authors}
                abstract={item.abstract}
                citation={item.citation}
              />
            ))}
          </div>
        </Container>
      </Section>
    );
  }

  if (section.type === "image-section") {
    return (
      <Section alt={index % 2 === 1}>
        <Container>
          <h2 class="section-title">{section.title}</h2>
          <div class="image-gallery">
            {section.images.map((img) => (
              <img src={withBase(img)} alt={section.title} class="reveal" />
            ))}
          </div>
        </Container>
      </Section>
    );
  }

  if (section.type === "map") {
    return (
      <Section alt={index % 2 === 1}>
        <Container>
          {section.title ? <h2 class="section-title">{section.title}</h2> : null}
          <div class="map-container reveal">
            <iframe
              src={section.src}
              width="100%"
              height="400"
              frameborder="0"
              allowfullscreen
              style="border: 0; border-radius: var(--radius-md);"
            />
          </div>
          {section.items && section.items.length > 0 ? (
            <div class="map-objects">
              <p class="map-objects-title">Объекты на карте:</p>
              <ol class="map-objects-list">
                {section.items.map((item) => (
                  <li>{item}</li>
                ))}
              </ol>
            </div>
          ) : null}
          {section.subtitle ? <p class="map-subtitle">{section.subtitle}</p> : null}
        </Container>
      </Section>
    );
  }

  if (section.type === "carousel") {
    const carouselId = `carousel-${index}`;
    return (
      <Section alt={index % 2 === 1}>
        <Container>
          {section.title ? <h2 class="section-title">{section.title}</h2> : null}
          <div class="carousel reveal" id={carouselId}>
            <div class="carousel-inner">
              {section.images.map((img, imgIndex) => (
                <div class={`carousel-slide ${imgIndex === 0 ? 'active' : ''}`}>
                  <img src={withBase(img)} alt={`${section.title} ${imgIndex + 1}`} />
                </div>
              ))}
            </div>
            <button class="carousel-btn carousel-prev" data-carousel={carouselId} aria-label="Предыдущий">&#10094;</button>
            <button class="carousel-btn carousel-next" data-carousel={carouselId} aria-label="Следующий">&#10095;</button>
            <div class="carousel-dots">
              {section.images.map((_, imgIndex) => (
                <button class={`carousel-dot ${imgIndex === 0 ? 'active' : ''}`} data-carousel={carouselId} data-index={imgIndex} aria-label={`Слайд ${imgIndex + 1}`}></button>
              ))}
            </div>
          </div>
        </Container>
      </Section>
    );
  }

  return null;
})}
